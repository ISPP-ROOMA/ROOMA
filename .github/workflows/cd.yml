name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - main
      - trunk
  push:
    branches:
      - trunk

  pull_request:
    branches:
      - trunk
      - main
    types:
      - closed

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ${{ github.repository }}/backend
  IMAGE_FRONTEND: ${{ github.repository }}/frontend

jobs:
  build-images:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.base_ref == 'main'

    outputs:
      release_tag: ${{ steps.get_tag.outputs.release_tag }}

    steps:
      - uses: actions/checkout@v3

      - name: Obtener tag desde título PR
        id: get_tag
        run: |
          TAG=$(echo "${{ github.event.pull_request.title }}" | tr ' ' '-' )
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Login GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Backend
        run: |
          docker build -t ghcr.io/${{ env.IMAGE_BACKEND }}:${{ steps.get_tag.outputs.release_tag }} ./backend
          docker push ghcr.io/${{ env.IMAGE_BACKEND }}:${{ steps.get_tag.outputs.release_tag }}

      - name: Build & Push Frontend
        run: |
          docker build -t ghcr.io/${{ env.IMAGE_FRONTEND }}:${{ steps.get_tag.outputs.release_tag }} ./frontend
          docker push ghcr.io/${{ env.IMAGE_FRONTEND }}:${{ steps.get_tag.outputs.release_tag }}

  deploy-entrega:
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event.pull_request.merged == true && github.base_ref == 'main'

    steps:
      - name: Generar password aleatoria
        id: gen_pass
        run: |
          PASS=$(openssl rand -base64 12)
          echo "db_pass=$PASS" >> $GITHUB_OUTPUT

      - name: Crear base de datos
        run: |
          curl -X POST https://api.alwaysdata.com/v1/databases \
          -H "Authorization: Bearer ${{ secrets.ALWAYSDATA_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
                "name": "rooma_${{ needs.build-images.outputs.release_tag }}",
                "type": "postgresql"
              }'

      - name: Crear usuario DB
        run: |
          curl -X POST https://api.alwaysdata.com/v1/database-users \
          -H "Authorization: Bearer ${{ secrets.ALWAYSDATA_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
                "username": "rooma_${{ needs.build-images.outputs.release_tag }}",
                "password": "${{ steps.gen_pass.outputs.db_pass }}"
              }'

      - name: Crear servicio backend Render
        id: render_create
        run: |
          RESPONSE=$(curl -s -X POST https://api.render.com/v1/services \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
                "type": "web_service",
                "name": "rooma-${{ needs.build-images.outputs.release_tag }}",
                "image": {
                  "url": "ghcr.io/${{ env.IMAGE_BACKEND }}:${{ needs.build-images.outputs.release_tag }}"
                },
                "envVars": [
                  {
                    "key": "DB_URL",
                    "value": "jdbc:postgresql://${{ secrets.ALWAYSDATA_HOST }}/rooma_${{ needs.build-images.outputs.release_tag }}"
                  },
                  {
                    "key": "DB_USER",
                    "value": "rooma_${{ needs.build-images.outputs.release_tag }}"
                  },
                  {
                    "key": "DB_PASS",
                    "value": "${{ steps.gen_pass.outputs.db_pass }}"
                  },
                  {
                    "key": "JWT_SECRET",
                    "value": "${{ secrets.JWT_SECRET }}"
                  }
                ]
              }')

          SERVICE_ID=$(echo $RESPONSE | jq -r '.id')
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT

      - name: Esperar a que Render esté listo
        run: |
          MAX_ATTEMPTS=40   # 40 x 15s = 10 minutos máximo
          ATTEMPT=0
          STATUS="building"
          while [ "$STATUS" != "live" ] && [ "$STATUS" != "failed" ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep 15
            ATTEMPT=$((ATTEMPT+1))
            STATUS=$(curl -s https://api.render.com/v1/services/${{ steps.render_create.outputs.service_id }} \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" | jq -r '.service.status')
            echo "Intento $ATTEMPT - Estado actual: $STATUS"
          done
          if [ "$STATUS" = "failed" ]; then
            echo "Render deployment failed"
            exit 1
          fi

      - name: Deploy frontend
        run: |
          cd frontend
          npm install -g vercel
          vercel --prod \
                 --name rooma-${{ needs.build-images.outputs.release_tag }} \
                 --token ${{ secrets.VERCEL_TOKEN }} \
                 --build-env VITE_API_URL=https://rooma-${{ needs.build-images.outputs.release_tag }}.onrender.com \
                 --yes

  deploy-dev:
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/trunk' ||
      (github.event.pull_request.merged == true && github.base_ref == 'trunk')

    steps:

      - name: Redeploy backend Render
        run: |
          curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

      - name: Esperar a backend Render
        run: |
          MAX_ATTEMPTS=40   # 40 x 15s = 10 minutos máximo
          ATTEMPT=0
          STATUS="building"
          while [ "$STATUS" != "live" ] && [ "$STATUS" != "failed" ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep 15
            ATTEMPT=$((ATTEMPT+1))
            STATUS=$(curl -s https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              | jq -r '.[0].status')

            echo "Intento $ATTEMPT - Estado actual: $STATUS"
          done
          if [ "$STATUS" = "failed" ]; then
            echo "Render deployment failed"
            exit 1
          fi

          if [ "$STATUS" != "live" ]; then
            echo "Timeout waiting for Render"
            exit 1
          fi
      - name: Deploy frontend Vercel
        run: |
          cd frontend
          npm install -g vercel
          vercel --prod \
                 --token ${{ secrets.VERCEL_TOKEN }} \
                 --build-env VITE_API_URL=${{ secrets.DEV_BACKEND_URL }} \
                 --yes