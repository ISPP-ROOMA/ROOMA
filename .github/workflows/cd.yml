name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - main
      - trunk

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/trunk' ||
      (github.event.pull_request.merged == true && github.base_ref == 'trunk')

    steps:

      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Redeploy backend Render
        run: |
          curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

      - name: Esperar a backend Render
        run: |
          MAX_ATTEMPTS=40   # 40 x 15s = 10 minutos m√°ximo
          ATTEMPT=0
          STATUS="building"
          while [ "$STATUS" != "live" ] && [ "$STATUS" != "failed" ] && [ "$STATUS" != "canceled" ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep 15
            ATTEMPT=$((ATTEMPT+1))
            STATUS=$(curl -s https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              | jq -r '.[0].deploy.status')

            echo "Intento $ATTEMPT - Estado actual: $STATUS"
          done
          if [ "$STATUS" = "failed" ] || [ "$STATUS" = "canceled" ]; then
            echo "Render deployment failed"
            exit 1
          fi

          if [ "$STATUS" != "live" ]; then
            echo "Timeout waiting for Render"
            exit 1
          fi
      - name: Deploy frontend Vercel
        run: |
          cd frontend
          npm install -g vercel
          vercel --prod \
                 --token ${{ secrets.VERCEL_TOKEN }} \
                 --build-env VITE_API_URL=${{ secrets.DEV_BACKEND_URL }} \
                 --build-env HUSKY=0 \
                 --yes